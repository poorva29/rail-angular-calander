@model MiraiConsultMVC.Models.Feed
@{
    ViewBag.Title = "Feed";
    Layout = "~/Views/Shared/_PatientMasterLayout.cshtml";
}
@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)
    {
        <div class="span12">
            <div class="answer-title">Answers </div>
        </div>
        <div class="custom-central-div">
            <div class="row-fluid">
                <div class="span12">
                    <div class="row-fluid ">
                        <div id="feed" class="margin_bottom">
                        </div>
                        <input type="hidden" id="HdnUserID" name="HdnUserID" value="@Model.HdnUserID" />
                        <input type="hidden" id="HdnRecordSize" name="HdnRecordSize" value="@Model.HdnRecordSize" />
                        <input type="hidden" id="HiddenUserType" name="HiddenUserType" value="@Model.HiddenUserType" />
                        <input type="hidden" id="hdnDocconnecturl" name="hdnDocconnecturl" value="@Model.hdnDocconnecturl" />
                        <input type="hidden" id="FacebookAppKey" name="FacebookAppKey" value="@Model.FacebookAppKey" />
                        <input type="hidden" id="AskmiraiUrl" name="AskmiraiUrl" value="@Model.AskmiraiUrl" />

                    </div>
                </div>
            </div>
            <div style="text-align: center" id="loadingImage">
                <img alt="Data Loading.." src="~/Content/image/ajax_loader.gif" style="width: 50px" />
            </div>
        </div>
        <script type="text/javascript" src="https://connect.facebook.net/en_US/all.js"></script>
        <script type="text/javascript" src="~/Content/js/utility.js"></script>
        <script type="text/javascript">
            var indexoF;
            $(function () {
                $(".navigation li.active").removeClass("active");
                $('#liFeed').addClass("active");
                $('#liAdminFeed').addClass("active");
                indexoF = 0;
                populateFeedData(indexoF);
            });
            $(window).scroll(function () {
                if ($(window).scrollTop() >= $(document).height() - $(window).height() - 10) {
                    indexoF = parseInt(indexoF) + 5
                    populateFeedData(indexoF)
                }
            });

            function populateFeedData(index) {
                var RecordSize = document.getElementById("HdnRecordSize").value;
                var UserId = document.getElementById("HdnUserID").value;
                var docconnecturl = document.getElementById("hdnDocconnecturl").value;
                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: "/Services/UserService.svc/getFeedList?lastQuestionNo=" + index + "&RecordSize=" + RecordSize + "&UserId=" + UserId + "&myFeed=" + 0 + "&isEncrypt=true",
                    success: function (response) {
                        var Question = 0;
                        response = JSON.parse(response);
                        if (response.length == 0) {
                            document.getElementById("loadingImage").style.visibility = "hidden"
                        }
                        for (indexcnt = 0; indexcnt < response.length; indexcnt++) {
                            var UserId = document.getElementById("HdnUserID").value, ansimg = '';
                            if (response[indexcnt].doctorimg && response[indexcnt].doctorimg)
                                var img = (response[indexcnt].photourl) + escape(response[indexcnt].doctorimg);
                            else
                                var img = "../Content/image/img-na.png";
                            if (response[indexcnt].answerimg)
                                var ansimg = "../feed/answerPhotos/" + escape(response[indexcnt].answerimg);
                            var template;
                            var endorsecount = response[indexcnt].endorsecount;
                            var thanxcount = response[indexcnt].thanxcount;
                            var answerid = response[indexcnt].answerid;
                            var title;
                            if (response[indexcnt].title != null)
                                title = response[indexcnt].title;
                            else
                                title = "";
                            template = "<div class='span12 custom-yellow-container'><div class='custom-inner-green-container'><a class='question_text' href='../answers/" + response[indexcnt].questionid + "'>" + response[indexcnt].questiontext + "</a></div> <div id=" + answerid + "ans>" +
                            "<div class='inner-count-likes pull-right' title='Thanked By Patient'> " + thanxcount + "</div><div class='inner-count-endorse pull-right' title='Endorsed'>" + endorsecount + " </div></div></div><div class='row-fluid'>" +
                            "<div class='row-fluid custom-occupy'><div class='span1 hidden-phone'><div class='center_align'><div class='feedDocImage img' style='margin-bottom:10px'><img src=" + img + "></div></div></div><div class='visible-phone feedDocImage img' style='margin-bottom:10px'><img src=" + img + "></div><div class='span6  middle-size-padding '><div class='ans_time_detail'>Dr. " + response[indexcnt].answerreplyedby + " </div><div class='title_text'><b>" + title + "</b></div></div>";
                            if (document.getElementById("HiddenUserType").value != "0") {
                                if (response[indexcnt].isdocconnectuser != false && docconnecturl != "")
                                    template = template + "<div class='span3 pull-right hidden-phone'><a class='btn book_appt_button' onclick='bookaptclicked(\"" + response[indexcnt].docid + "\")' href='" + docconnecturl + response[indexcnt].docid + "&frmaskmirai=1' Class='btn book_appt_button' target='_blank' > Book Appointment </a><br/><br/></div>";
                            }
                            template = template + "</div>";
                            if (ansimg.length > 0) {
                                template = template + "<div class='row-fluid'><div class='span5 offset1'><p class='ans_text intermediate-size-padding' style='word-wrap: break-word;'>" + response[indexcnt].answertext + "</p></div><div class='span3'><div class=''><div class='feedAnsImage img'><img src=" + ansimg + "></div></div></div></div>";
                            }
                            else {
                                template = template + "<div class='row-fluid'><div class='span11 pull-right middle-size-padding'><p class='ans_text' style='word-wrap: break-word;'>" + response[indexcnt].answertext + "</p></div></div>";
                            }
                            if (document.getElementById("HiddenUserType").value != "0") {
                                if (response[indexcnt].isdocconnectuser != false && docconnecturl != "")
                                    template = template + "<div class='span3 pull-left visible-phone'><a class='btn book_appt_button' onclick='bookaptclicked(\"" + response[indexcnt].docid + "\")' href='" + docconnecturl + response[indexcnt].docid + "&frmaskmirai=1' Class='btn book_appt_button' target='_blank' > Book Appointment </a></div>";
                            }
                            if (document.getElementById("HiddenUserType").value != "0") {
                                template = template + "<div class='row-fluid margintop_tosharebutn'>";

                                var url = document.getElementById("AskmiraiUrl").value;;
                                var FBappkey = document.getElementById("FacebookAppKey").value;
                                template = template + "<div class='top_marging_sharelink' style='width:100%'><div style='width:67%' class='hidden-phone pull-left'><hr style='margin:12px;'/></div><a href='#' onclick='shareOnFacebook(\"" + escape(response[indexcnt].questiontext) + "\",\"" + escape(response[indexcnt].answertext) + "\", \"" + escape(response[indexcnt].questionid) + "\", \"" + url.toString() + "\",\"" + FBappkey.toString() + "\")'><img title='Facebook' class='share_icons_width' src='../Content/image/fb.png' alt='Facebook'></a>" +
                                //"<a class='share_link-margin ' target='_blank'  href='https://twitter.com/intent/tweet?button_hashtag=TwitterStories&text= Q. " + escape(response[indexcnt].questiontext) + " \n Ans. " + escape(response[indexcnt].answertext) + "'><img title='Twitter' class='share_icons_width' src='../Resources/image/twitter.png' alt='Twitter'></a>" +
                                "<a class='share_link-margin ' target='_blank'  href='https://twitter.com/intent/tweet?button_hashtag=TwitterStories&text= " + url.toString() + "/answers/" + escape(response[indexcnt].questionid) + "'><img title='Twitter' class='share_icons_width' src='../Content/image/twitter.png' alt='Twitter'></a>" +
                                "<a class='share_link-margin ' target='' style='margin-right:10px;' href='mailto:?Subject=Mirai Consult has been shared an Answer with you &amp;Body= Q. " + escape(response[indexcnt].questiontext) + " %0D%0A  Ans. " + escape(response[indexcnt].answertext) + "'><img title='Email' class='share_icons_width' src='../Content/image/mail.png' alt='Email'></a>";
                                if (response[indexcnt].ispatientthank) {
                                    template = template + "<a class='custom-green-text'><img src='../Content/image/thanks.png'/> Thanks its useful</a></div></div><br/>";
                                }
                                else {
                                    var QuestionText = response[indexcnt].questiontext.replace(/\s{2,}/g, ' ');
                                    template = template + "<a class=\"custom-link\" onclick=\"return thankToDoctor(" + UserId + "," + response[indexcnt].answerid + ",this,'" + response[indexcnt].docLastname + "','" + response[indexcnt].docmobileno + "','" + response[indexcnt].doctEmail + "','" + escape(QuestionText) + "')\">Is it useful?</a><br/>";
                                }
                            }

                            $("#feed").append(template);
                            Question++;
                        }
                        if (response.length == 0 && $("#feed").html().trim().length == 0) {
                            $('#feed')[0].innerHTML = 'No records found';
                        }
                        if (Question < 3) {
                            document.getElementById("loadingImage").style.visibility = "hidden"
                        }
                    },
                    error: function () {
                    }
                });
            }
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-48132984-2', 'askmirai.com');
            ga('send', 'pageview');

        </script>
    }
}