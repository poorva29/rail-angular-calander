@model IEnumerable<MiraiConsultMVC.Models.Report>

@{
    ViewBag.Title = "Report";
    if (Session["UserId"] == null)
    {
        Layout = "~/Views/Shared/_AskmiraiMasterLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_PatientMasterLayout.cshtml";
    }

}
<link rel="stylesheet" href="~/Content/chosen/chosen.css" />
<script type="text/javascript" src="~/Content/chosen/chosen.jquery.js"></script>
<script type="text/javascript" src="~/Content/js/jquery.dataTables.js"></script>
<script type="text/javascript" src="~/Content/js/bootstrap-pagination.js"></script>
<div class="row-fluid">
    <div class="span12 main-outter-padding">
        <div class='row-fluid '>
            <div class="span9">
                <div class=" finddoc-title ">
                    Reports
                </div>
            </div>
            <div class="span3">
                <div style="float: right">
                    Average response time: @ViewBag.avgresponsetime
                </div>
            </div>
        </div>
        <div class="row-fluid content_border find-Doc-gbColor div-left-padding-large" style="padding-left:0">
            
@using (Ajax.BeginForm("Report", new AjaxOptions
                                    {
                                        HttpMethod = "get",
                                        InsertionMode = InsertionMode.Replace,
                                        UpdateTargetId = "DoctorsReoprt"
                                    }))
                            {
    <div class="span4 div-left-padding">
                <div class="margin-bottom-tolabel" style="min-width: 220px;">
                    Enter Speciality or Doctor's Name
                </div>
                <input type="text" class="find_Doc_inputbox" id="txtSpecialityOrName" name="specialityOrName" style="width: 200px" placeholder="Enter Speciality or Doctor Name" />
            </div>
            <div class="span4 city-div-left-padding">
                <div class="margin-bottom-tolabel">
                    Select City
                </div>
                <div id="div-city-select" class="city_chzn">
                    <select id="city-select" data-placeholder="Select City" name="cityid" class="chzn-select chzn_div_width" style="width: 215px">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="span4 location_margin">
                <div class="margin-bottom-tolabel">
                    Select Location
                </div>
                <select id="locality-select" data-placeholder="Select Location" name="locationid" class="chzn-select chosen_margin chzn_div_width" style="width: 215px">
                    <option value=""></option>
                </select>
            </div>
            <div class="row-fluid">
                <div class="span12 div-left-padding">
                    <input type="submit" class="btn thanx search_margin" value="Search">
                </div>
            </div>
}
        </div>
        <div class='row-fluid div_margin_bottom'>
            <div class="span12 ">
                <div class="table-responsive">
                    <table cellpadding="0" cellspacing="0" border="0" class="custom-table zebra-striped dataTable"
                            id="report-doctor-list" style="table-layout:fixed">
                        <thead>
                            <tr>
                                <th style="width: 20%" class="table-heading-color">
                                    <b>Doctor</b>
                                </th>
                                <th class="table-heading-color">
                                    <b>City</b>
                                </th>
                                <th class="table-heading-color">
                                    <b>Location</b>
                                </th>
                                <th class="reporttablewidth table-heading-color" style="word-wrap: break-word; width: 15%;">
                                    <b>Appointments booked</b>
                                </th>
                                <th class="reporttablewidth table-heading-color" style="word-wrap: break-word; width: 15%">
                                    <b>Appointments Clicked</b>
                                </th>
                                <th class="reporttablewidth table-heading-color" style="word-wrap:break-word">
                                    <b>Avg response time (hours)</b>
                                </th>
                            </tr>
                        </thead>
                        @Html.Partial("_Report", Model)
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<asp:HiddenField ID="hdncityval" ClientIDMode="Static" runat="server" Value="" />
<asp:HiddenField ID="hdnlocationsval" ClientIDMode="Static" runat="server" Value="" />
<asp:HiddenField ID="hdnSpecialityOrNameval" ClientIDMode="Static" runat="server" Value="" />

<script type="text/javascript">
    $(".chzn-select").chosen({ allow_single_deselect: true });

    $(function () {
        ajaxFormSubmit = function () {
            var $form = $(this);

            var options = {
                url: $form.attr("action"),
                type: $form.attr("data-ajax-method"),
                data: $form.serialize()
            };

            $.ajax(options).done(function (data) {
                var $target = $($form.attr("data-ajax-update"));
                $target.replaceWith(data);
                initDoctorListDataTable();
            });
            return false;
        };
        $("form[data-ajax='true']").submit(ajaxFormSubmit);
    })
    $(function () {
        $(".navigation li.active").removeClass("active");
        $('#liReports').addClass("active");
        initDoctorListDataTable();
        if ($('#hdnSpecialityOrNameval')[0].value != '')
            $('#txtSpecialityOrName').val($('#hdnSpecialityOrNameval')[0].value);
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '../../Services/UserService.svc/fillDropdowns',
            success: function (response) {
                response = JSON.parse(response);
                for (cnt = 0; cnt < response.length; cnt++)
                    $('#city-select').append(
                    $('<option></option>')
                        .val(response[cnt]["cityid"])
                        .html(response[cnt]["name"]));

                if ($('#hdncityval')[0].value != '')
                    $('#city-select').val($('#hdncityval')[0].value);
                $(".chzn-select").trigger("liszt:updated");
                if ($('#city-select').val() != "")
                    getLocationsbyCity();
            },
            error: function (data) {
                if (data.responseText.indexOf('Authentication failed') > -1) {
                    location.reload();
                }
            }
        });
    });

    $('#div-city-select').on('change', '#city-select', function () {       
        if ($('#city-select').val() != "") {
            getLocationsbyCity();
        }
        else
        {
            $('#locality-select').empty();
            $('#locality-select').append('<option></option>');
            $(".chzn-select").trigger("liszt:updated");
        }
    });

    function getLocationsbyCity() {
        $.ajax({
            type: 'POST',
            dataType: 'json',
            data: '"' + $('#city-select').val() + '"',
            contentType: 'application/json',
            url: '../../Services/UserService.svc/getLocationsbyCity',
            success: function (response) {
                $('#locality-select').empty();
                $('#locality-select').append('<option></option>');
                response = JSON.parse(response);
                for (cnt = 0; cnt < response.length; cnt++)
                    $('#locality-select').append(
                    $('<option></option>')
                        .val(response[cnt]["locationid"])
                        .html(response[cnt]["name"]));
                $('#locality-select').append('<option></option>');
                if ($('#hdnlocationsval')[0].value != '')
                    $('#locality-select').val($('#hdnlocationsval')[0].value);
                $(".chzn-select").trigger("liszt:updated");
            },
            error: function (data) {
                if (data.responseText.indexOf('Authentication failed') > -1) {
                    location.reload();
                }
            }
        });
    }

    function initDoctorListDataTable() {
        $('#report-doctor-list').dataTable({
            "bSort": true,
            "sDom": "t<'row-fluid'<'span6'i><'span6 float_right'p>>",
            "sPaginationType": "bootstrap",
            "bDestroy": true,
            "oLanguage": {
                "sLengthMenu": "_MENU_ records per page"
            }
        });
    }

    function btnSearchDoctor_Click() {
        $('#hdncityval')[0].value = $('#city-select').val();
        $('#hdnlocationsval')[0].value = $('#locality-select').val();
        $('#hdnSpecialityOrNameval')[0].value = $('#txtSpecialityOrName').val();
        __doPostBack('SearchDoctors', 0);
    };

    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-48132984-2', 'askmirai.com');
    ga('send', 'pageview');

</script>
